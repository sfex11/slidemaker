name: Deploy to Oracle Server

on:
  push:
    branches: [master]

concurrency:
  group: deploy-oracle-production
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: 129.154.63.231
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -euo pipefail

            APP_DIR="/home/ubuntu/slidemaker"
            REPO_URL="https://github.com/sfex11/slidemaker.git"
            SERVICE_NAME="slide-maker"
            PUBLIC_HOST="129.154.63.231"
            LOCK_FILE="/tmp/${SERVICE_NAME}.deploy.lock"
            DB_FILE="${APP_DIR}/prisma/dev.db"
            DB_BACKUP="/tmp/${SERVICE_NAME}.dev.db.bak"

            probe_http() {
              local url="$1"
              local code
              code=$(curl -sS -o /dev/null -w "%{http_code}" --max-time 10 "$url" || true)
              if [ -z "$code" ]; then
                code="000"
              fi
              echo "$code"
            }

            # 중복 배포 방지
            exec 9>"${LOCK_FILE}"
            flock -n 9 || { echo "Another deployment is already running"; exit 1; }

            export PATH="/home/ubuntu/.bun/bin:${PATH}"

            # Bun 설치 확인
            if ! command -v bun >/dev/null 2>&1; then
              curl -fsSL https://bun.sh/install | bash
              export PATH="/home/ubuntu/.bun/bin:${PATH}"
            fi

            # 절대경로 고정: 디렉토리가 없으면 클론
            if [ ! -d "${APP_DIR}/.git" ]; then
              sudo mkdir -p "${APP_DIR}"
              sudo chown -R ubuntu:ubuntu "${APP_DIR}"
              git clone "${REPO_URL}" "${APP_DIR}"
            fi

            # 추적된 prisma/dev.db가 덮어써지는 문제 방지(임시 백업)
            if [ -f "${DB_FILE}" ]; then
              cp "${DB_FILE}" "${DB_BACKUP}"
            fi

            cd "${APP_DIR}"

            # 안전한 동기화: pull 대신 원격 master로 강제 정렬
            git fetch --prune origin master
            git reset --hard origin/master
            git clean -fd

            # DB 복원
            if [ -f "${DB_BACKUP}" ]; then
              cp "${DB_BACKUP}" "${DB_FILE}"
            fi

            # 의존성/DB/빌드
            bun install --frozen-lockfile
            bun run db:generate
            bun run db:push
            bun run build

            # 서비스 파일은 매 배포 시 최신으로 반영
            sudo install -m 644 "${APP_DIR}/deploy/slide-maker.service" "/etc/systemd/system/${SERVICE_NAME}.service"
            sudo systemctl daemon-reload
            sudo systemctl enable "${SERVICE_NAME}"

            # 서비스 재시작 및 상태 확인
            sudo systemctl restart "${SERVICE_NAME}"
            sudo systemctl --no-pager --full status "${SERVICE_NAME}" | sed -n '1,30p'

            # Nginx가 3001 업스트림을 바라보는 경우 3003으로 자동 동기화
            if command -v nginx >/dev/null 2>&1; then
              NGINX_PORT_FILES="/tmp/${SERVICE_NAME}.nginx-port-files.txt"
              sudo grep -RIlE "(127\\.0\\.0\\.1|localhost):3001" /etc/nginx > "${NGINX_PORT_FILES}" || true

              if [ -s "${NGINX_PORT_FILES}" ]; then
                while IFS= read -r file; do
                  sudo sed -i -E "s/(127\\.0\\.0\\.1|localhost):3001/\\1:3003/g" "${file}"
                done < "${NGINX_PORT_FILES}"

                sudo nginx -t
                sudo systemctl reload nginx
              fi
            fi

            # 헬스체크(앱 내부 포트 기준, 실패 시 배포 실패)
            curl -fsS --max-time 10 "http://127.0.0.1:3003/api/health"

            echo ""
            echo "=== Deployment Reachability Diagnostics ==="
            echo "Expected direct app URL: http://${PUBLIC_HOST}:3003/"
            echo "Expected proxied URL (if Nginx configured): http://${PUBLIC_HOST}/"

            echo ""
            echo "[1/4] Listening ports"
            sudo ss -lntp | grep -E "(:3003|:80|:443)" || true

            echo ""
            echo "[2/4] Local loopback checks"
            LOCAL_APP_HEALTH=$(probe_http "http://127.0.0.1:3003/api/health")
            LOCAL_APP_ROOT=$(probe_http "http://127.0.0.1:3003/")
            echo "127.0.0.1:3003/api/health => ${LOCAL_APP_HEALTH}"
            echo "127.0.0.1:3003/           => ${LOCAL_APP_ROOT}"

            if command -v nginx >/dev/null 2>&1; then
              NGINX_LOCAL_ROOT=$(probe_http "http://127.0.0.1/")
              NGINX_LOCAL_HEALTH=$(probe_http "http://127.0.0.1/api/health")
              echo "127.0.0.1/                => ${NGINX_LOCAL_ROOT}"
              echo "127.0.0.1/api/health      => ${NGINX_LOCAL_HEALTH}"
            fi

            echo ""
            echo "[3/4] Public host checks"
            PUBLIC_APP_HEALTH=$(probe_http "http://${PUBLIC_HOST}:3003/api/health")
            PUBLIC_APP_ROOT=$(probe_http "http://${PUBLIC_HOST}:3003/")
            PUBLIC_WEB_ROOT=$(probe_http "http://${PUBLIC_HOST}/")
            PUBLIC_WEB_HEALTH=$(probe_http "http://${PUBLIC_HOST}/api/health")
            echo "${PUBLIC_HOST}:3003/api/health => ${PUBLIC_APP_HEALTH}"
            echo "${PUBLIC_HOST}:3003/           => ${PUBLIC_APP_ROOT}"
            echo "${PUBLIC_HOST}/                => ${PUBLIC_WEB_ROOT}"
            echo "${PUBLIC_HOST}/api/health      => ${PUBLIC_WEB_HEALTH}"

            echo ""
            echo "[4/4] Quick interpretation"
            if [ "${PUBLIC_APP_HEALTH}" != "200" ]; then
              echo "WARN: :3003 direct access is not 200. Check cloud security list / UFW / iptables for TCP 3003."
            fi
            if [ "${PUBLIC_WEB_ROOT}" = "000" ] || [ "${PUBLIC_WEB_ROOT}" = "404" ]; then
              echo "WARN: root domain is not routed to app. Check Nginx server_name and proxy_pass to 127.0.0.1:3003."
            fi
            if [ "${PUBLIC_APP_HEALTH}" = "200" ]; then
              echo "OK: Direct app URL should work at http://${PUBLIC_HOST}:3003/"
            fi
            if [ "${PUBLIC_WEB_ROOT}" = "200" ] || [ "${PUBLIC_WEB_ROOT}" = "301" ] || [ "${PUBLIC_WEB_ROOT}" = "302" ]; then
              echo "OK: Proxied URL should work at http://${PUBLIC_HOST}/"
            fi
