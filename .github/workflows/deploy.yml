name: Deploy to Oracle Server

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: 129.154.63.231
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd ~/slidemaker

            # 최신 코드 가져오기
            git pull origin master

            # Bun 설치 확인
            if ! command -v bun &> /dev/null; then
              curl -fsSL https://bun.sh/install | bash
            fi

            # 의존성 설치
            bun install

            # Prisma 설정
            bun run db:generate
            bun run db:push

            # 빌드
            bun run build

            # systemd 서비스 파일 복사 (최초 1회만)
            if [ ! -f /etc/systemd/system/slide-maker.service ]; then
              sudo cp deploy/slide-maker.service /etc/systemd/system/
              sudo systemctl daemon-reload
              sudo systemctl enable slide-maker
            fi

            # 서비스 재시작
            sudo systemctl restart slide-maker
            sudo systemctl status slide-maker
